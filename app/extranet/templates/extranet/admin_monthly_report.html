{% extends 'extranet/base.html' %}
{% block title %}Rapport Mensuel RH - ICTGROUP{% endblock %}

{% block content %}
<main role="main" class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-extrabold text-primary mb-4 text-center tracking-tight flex items-center justify-center gap-3">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Rapport Mensuel RH
    </h1>
    <p class="text-gray-600 text-center mb-6">
        Analyse d√©taill√©e de l'activit√© mensuelle des collaborateurs
    </p>
    
    <!-- Filtres et actions -->
    <section class="bg-gradient-to-r from-primary/5 to-secondary/5 p-6 rounded-xl shadow-sm mb-6" aria-labelledby="filters-section">
        <h2 id="filters-section" class="text-lg font-bold text-primary mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
            </svg>
            P√©riode d'analyse
        </h2>
        <form method="get" 
                class="flex flex-wrap items-end gap-4"
                role="form"
                aria-label="S√©lection de la p√©riode d'analyse">
            <div class="form-group">
                <label for="month" class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Mois
                </label>
                <select id="month" 
                        name="month" 
                        class="p-3 border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200"
                        aria-describedby="month-help">
                    {% for m in month_range %}
                        {% with m_str=m|stringformat:'02d' %}
                        <option value="{{ m_str }}" {% if selected_month|slice:'5:' == m_str %}selected{% endif %}>
                            {% if m == 1 %}Janvier{% elif m == 2 %}F√©vrier{% elif m == 3 %}Mars{% elif m == 4 %}Avril{% elif m == 5 %}Mai{% elif m == 6 %}Juin{% elif m == 7 %}Juillet{% elif m == 8 %}Ao√ªt{% elif m == 9 %}Septembre{% elif m == 10 %}Octobre{% elif m == 11 %}Novembre{% elif m == 12 %}D√©cembre{% endif %}
                        </option>
                        {% endwith %}
                    {% endfor %}
                </select>
                <p id="month-help" class="mt-1 text-sm text-gray-500">Mois d'analyse</p>
            </div>
            
            <div class="form-group">
                <label for="year" class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Ann√©e
                </label>
                <select id="year" 
                        name="year" 
                        class="p-3 border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200"
                        aria-describedby="year-help">
                    {% for y in year_range %}
                        {% with y_str=y|stringformat:'04d' %}
                        <option value="{{ y_str }}" {% if selected_month|slice:':4' == y_str %}selected{% endif %}>{{ y_str }}</option>
                        {% endwith %}
                    {% endfor %}
                </select>
                <p id="year-help" class="mt-1 text-sm text-gray-500">Ann√©e d'analyse</p>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" 
                        class="inline-flex items-center px-4 py-3 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white font-bold rounded-lg transition-all duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                        aria-label="Afficher le rapport pour la p√©riode s√©lectionn√©e">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    G√©n√©rer le rapport
                </button>
                
                <a href="?export=csv&month={{ selected_month|slice:'5:' }}&year={{ selected_month|slice:':4' }}" 
                    class="inline-flex items-center px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                    aria-label="Exporter le rapport au format CSV">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Exporter CSV
                </a>
            </div>
        </form>
    </section>
    
    <!-- Statistiques du mois -->
    {% if users %}
    <section class="mb-8" aria-labelledby="monthly-stats">
        <h2 id="monthly-stats" class="text-xl font-bold text-primary mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Statistiques du mois
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                <div class="text-3xl font-bold text-blue-600">{{ users|length }}</div>
                <div class="text-sm text-gray-500">üë• Collaborateurs</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-green-500">
                <div class="text-3xl font-bold text-green-600" id="total-office-days">‚Äî</div>
                <div class="text-sm text-gray-500">üè¢ Jours bureau</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-purple-500">
                <div class="text-3xl font-bold text-purple-600" id="total-telework-days">‚Äî</div>
                <div class="text-sm text-gray-500">üè† Jours t√©l√©travail</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-orange-500">
                <div class="text-3xl font-bold text-orange-600" id="total-leave-days">‚Äî</div>
                <div class="text-sm text-gray-500">üèñÔ∏è Jours de cong√©</div>
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- Tableau du rapport -->
    <section class="bg-white rounded-xl shadow-lg overflow-hidden" aria-labelledby="report-table">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 id="report-table" class="text-lg font-medium text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                D√©tail par collaborateur
                {% if selected_month %}
                    - {{ selected_month|slice:'5:' }}/{{ selected_month|slice:':4' }}
                {% endif %}
            </h2>
        </div>
        
        {% if users %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" role="table" aria-label="Rapport mensuel des collaborateurs">
                    <thead class="bg-gradient-to-r from-primary to-secondary text-white">
                        <tr role="row">
                            <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Collaborateur
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Site
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    üè¢ Bureau
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    üè† T√©l√©travail
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    üèñÔ∏è Cong√©s
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    üí∞ Solde
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for user in users %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150" role="row"
                            data-office="{{ user.days_at_office|default:0 }}"
                            data-telework="{{ user.days_telework|default:0 }}"
                            data-leave="{{ user.days_leave|default:0 }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        <div class="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center">
                                            <span class="text-primary font-bold text-sm">
                                                {{ user.first_name|slice:":1"|upper }}{{ user.last_name|slice:":1"|upper }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ user.first_name }} {{ user.last_name }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {{ user.username }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if user.profile.site|lower == 'tunisie' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {% if user.profile.site|lower == 'tunisie' %}üáπüá≥ {{ user.profile.site }}{% else %}üá´üá∑ {{ user.profile.site }}{% endif %}
                                </span>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <div class="text-lg font-bold text-green-600">{{ user.days_at_office|default:0 }}</div>
                                <div class="text-sm text-gray-500">jour{{ user.days_at_office|default:0|pluralize }}</div>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <div class="text-lg font-bold text-purple-600">{{ user.days_telework|default:0 }}</div>
                                <div class="text-sm text-gray-500">jour{{ user.days_telework|default:0|pluralize }}</div>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <div class="text-lg font-bold text-orange-600">{{ user.days_leave|floatformat:1|default:0 }}</div>
                                <div class="text-sm text-gray-500">jour{{ user.days_leave|floatformat:1|default:0|pluralize }}</div>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <div class="text-lg font-bold 
                                    {% if user.leave_balance > 20 %}text-green-600{% elif user.leave_balance > 10 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ user.leave_balance|default:0 }}
                                </div>
                                <div class="text-sm text-gray-500">jour{{ user.leave_balance|default:0|pluralize }} restant{{ user.leave_balance|default:0|pluralize }}</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <!-- √âtat vide optimis√© -->
            <div class="text-center py-16">
                <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Aucune donn√©e disponible</h3>
                <p class="mt-2 text-gray-500">
                    Aucun collaborateur trouv√© pour la p√©riode s√©lectionn√©e.
                </p>
            </div>
        {% endif %}
    </section>
</main>

<style>
/* Animations d'apparition */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 0.6s ease-out;
}

/* Focus visible am√©lior√© */
:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Hover effects pour les lignes du tableau */
tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

/* Transitions fluides */
button, a, select {
    transition: all 0.2s ease-in-out;
}

/* Animation des statistiques */
.animate-counter {
    animation: fade-in 1s ease-out;
}

/* Styles pour les cartes de statistiques */
.stat-card {
    transition: transform 0.2s ease-in-out;
}

.stat-card:hover {
    transform: translateY(-2px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation progressive des lignes du tableau
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        setTimeout(() => {
            row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
    
    // Calcul et affichage des totaux
    function calculateTotals() {
        let totalOffice = 0;
        let totalTelework = 0;
        let totalLeave = 0;
        
        tableRows.forEach(row => {
            const officeData = row.getAttribute('data-office');
            const teleworkData = row.getAttribute('data-telework');
            const leaveData = row.getAttribute('data-leave');
            
            if (officeData) totalOffice += parseInt(officeData) || 0;
            if (teleworkData) totalTelework += parseInt(teleworkData) || 0;
            if (leaveData) totalLeave += parseFloat(leaveData) || 0;
        });
        
        // Animation des compteurs
        animateCounter('total-office-days', totalOffice);
        animateCounter('total-telework-days', totalTelework);
        animateCounter('total-leave-days', totalLeave.toFixed(1));
    }
    
    // Animation des compteurs
    function animateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const duration = 1000; // 1 seconde
        const steps = 30;
        const stepValue = targetValue / steps;
        let currentValue = 0;
        
        const timer = setInterval(() => {
            currentValue += stepValue;
            if (currentValue >= targetValue) {
                element.textContent = targetValue;
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(currentValue);
            }
        }, duration / steps);
    }
    
    // Animation des cartes de statistiques
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
        }, index * 100);
    });
    
    // Calcul des totaux si des donn√©es sont pr√©sentes
    if (tableRows.length > 0) {
        setTimeout(calculateTotals, 500);
    }
    
    // Mise en √©vidence des valeurs faibles de solde de cong√©s
    tableRows.forEach(row => {
        const leaveBalanceCell = row.cells[5]; // Derni√®re colonne
        if (leaveBalanceCell) {
            const leaveBalance = parseInt(leaveBalanceCell.querySelector('div').textContent);
            if (leaveBalance <= 5) {
                leaveBalanceCell.classList.add('bg-red-50');
            } else if (leaveBalance <= 10) {
                leaveBalanceCell.classList.add('bg-yellow-50');
            }
        }
    });
    
    // Auto-submit du formulaire quand la s√©lection change
    const monthSelect = document.getElementById('month');
    const yearSelect = document.getElementById('year');
    
    function autoSubmit() {
        // Auto-submit apr√®s un d√©lai pour permettre la s√©lection multiple
        setTimeout(() => {
            const form = document.querySelector('form[role="form"]');
            if (form) {
                form.submit();
            }
        }, 300);
    }
    
    if (monthSelect) monthSelect.addEventListener('change', autoSubmit);
    if (yearSelect) yearSelect.addEventListener('change', autoSubmit);
});
</script>
{% endblock %}
