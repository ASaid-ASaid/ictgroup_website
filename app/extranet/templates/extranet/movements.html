{% extends 'extranet/base.html' %}
{% block title %}Historique des Mouvements de Stock - ICTGROUP{% endblock %}

{% block content %}
<main role="main" class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-extrabold text-primary mb-4 text-center tracking-tight flex items-center justify-center gap-3">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
        </svg>
        Historique des Mouvements
    </h1>
    <p class="text-gray-600 text-center mb-6">
        Consultez l'historique complet des entr√©es et sorties de stock
    </p>
    
    <!-- Statistiques et filtres -->
    <section class="bg-gradient-to-r from-primary/5 to-secondary/5 p-6 rounded-xl shadow-sm mb-6" aria-labelledby="movements-stats">
        <h2 id="movements-stats" class="text-lg font-bold text-primary mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            R√©sum√© des mouvements
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                <div class="text-2xl font-bold text-primary">{{ movements|length }}</div>
                <div class="text-sm text-gray-500">Total mouvements</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                <div class="text-2xl font-bold text-green-600" data-stat="entries">
                    0
                </div>
                <div class="text-sm text-gray-500">üì• Entr√©es</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                <div class="text-2xl font-bold text-red-600" data-stat="exits">
                    0
                </div>
                <div class="text-sm text-gray-500">üì§ Sorties</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                <div class="text-2xl font-bold text-secondary" data-stat="unique-items">
                    0
                </div>
                <div class="text-sm text-gray-500">Articles concern√©s</div>
            </div>
        </div>
    </section>
    
    <!-- Tableau des mouvements optimis√© -->
    <section class="bg-white rounded-xl shadow-lg overflow-hidden" aria-labelledby="movements-table">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 id="movements-table" class="text-lg font-medium text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Liste des mouvements de stock
            </h2>
            <!-- Barre de recherche -->
            <div class="mt-4">
                <div class="relative">
                    <input type="text" 
                           id="search-movements" 
                           placeholder="Rechercher par article, utilisateur ou remarque..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        {% if movements %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" role="table" aria-label="Mouvements de stock">
                    <thead class="bg-gradient-to-r from-primary to-secondary text-white">
                        <tr role="row">
                            <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Date & Heure
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Utilisateur
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    Article
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                Type
                            </th>
                            <th scope="col" class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wider">
                                Quantit√©
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider">
                                Remarques
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="movements-tbody">
                        {% for movement in movements %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150 searchable-row" role="row"
                            data-search="{{ movement.stock_item.designation|lower }} {{ movement.user.get_full_name|default:movement.user.username|lower }} {{ movement.remarks|lower }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900">
                                        {{ movement.date|date:"d/m/Y" }}
                                    </div>
                                    <div class="text-gray-500">
                                        {{ movement.date|date:"H:i" }}
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">
                                            <span class="text-primary font-semibold text-sm">
                                                {{ movement.user.get_full_name|default:movement.user.username|slice:":2"|upper }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ movement.user.get_full_name|default:movement.user.username }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {{ movement.user.email }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900">
                                        {{ movement.stock_item.designation }}
                                    </div>
                                    <div class="text-gray-500">
                                        Code: {{ movement.stock_item.code }}
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if movement.movement_type == 'entry' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {% if movement.movement_type == 'entry' %}
                                        üì• {{ movement.get_movement_type_display|default:"Entr√©e" }}
                                    {% else %}
                                        üì§ {{ movement.get_movement_type_display|default:"Sortie" }}
                                    {% endif %}
                                </span>
                            </td>
                            
                            <td class="px-6 py-4 text-center">
                                <div class="text-lg font-bold
                                    {% if movement.movement_type == 'entry' %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if movement.movement_type == 'entry' %}+{% else %}-{% endif %}{{ movement.quantity }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    unit√©{{ movement.quantity|pluralize }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900 max-w-xs">
                                    {% if movement.remarks %}
                                        <div class="truncate" title="{{ movement.remarks }}">
                                            {{ movement.remarks }}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400 italic">Aucune remarque</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- √âtat de recherche vide -->
            <div id="no-results" class="hidden text-center py-12">
                <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Aucun r√©sultat trouv√©</h3>
                <p class="mt-2 text-gray-500">
                    Essayez de modifier vos crit√®res de recherche.
                </p>
            </div>
        {% else %}
            <!-- √âtat vide optimis√© -->
            <div class="text-center py-16">
                <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Aucun mouvement enregistr√©</h3>
                <p class="mt-2 text-gray-500 max-w-sm mx-auto">
                    Il n'y a encore aucun mouvement de stock enregistr√© dans le syst√®me.
                </p>
                <div class="mt-6">
                    <a href="{% url 'extranet:entry_exit' %}" 
                       class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Enregistrer un mouvement
                    </a>
                </div>
            </div>
        {% endif %}
    </section>
</main>

<style>
/* Animations d'apparition */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 0.6s ease-out;
}

/* Focus visible am√©lior√© */
:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Hover effects pour les lignes du tableau */
tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

/* Transitions fluides pour les √©l√©ments interactifs */
button, a, input {
    transition: all 0.2s ease-in-out;
}

/* Animation pour les stats */
.animate-stats {
    animation: fade-in 0.8s ease-out;
}

/* Styles pour la recherche */
#search-movements:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Highlight pour les r√©sultats de recherche */
.highlight {
    background-color: rgba(255, 235, 59, 0.3);
    font-weight: 600;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calcul des statistiques
    calculateStatistics();
    
    // Animation progressive des lignes du tableau
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        setTimeout(() => {
            row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
    
    // Fonctionnalit√© de recherche en temps r√©el
    const searchInput = document.getElementById('search-movements');
    const searchableRows = document.querySelectorAll('.searchable-row');
    const noResults = document.getElementById('no-results');
    const tableBody = document.getElementById('movements-tbody');
    
    if (searchInput && searchableRows.length > 0) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;
            
            searchableRows.forEach(row => {
                const searchData = row.getAttribute('data-search');
                const isVisible = searchData.includes(searchTerm);
                
                if (isVisible) {
                    row.style.display = '';
                    visibleCount++;
                    
                    // Highlight des termes trouv√©s
                    if (searchTerm) {
                        highlightSearchTerm(row, searchTerm);
                    } else {
                        removeHighlight(row);
                    }
                } else {
                    row.style.display = 'none';
                    removeHighlight(row);
                }
            });
            
            // Afficher/masquer le message "aucun r√©sultat"
            if (visibleCount === 0 && searchTerm) {
                noResults.classList.remove('hidden');
                tableBody.style.display = 'none';
            } else {
                noResults.classList.add('hidden');
                tableBody.style.display = '';
            }
            
            // Recalculer les statistiques avec les r√©sultats filtr√©s
            if (searchTerm) {
                calculateFilteredStatistics(searchTerm);
            } else {
                calculateStatistics();
            }
        });
    }
    
    // Fonction pour surligner les termes de recherche
    function highlightSearchTerm(row, term) {
        const textNodes = getTextNodes(row);
        textNodes.forEach(node => {
            const text = node.textContent;
            const lowercaseText = text.toLowerCase();
            const index = lowercaseText.indexOf(term);
            
            if (index !== -1) {
                const beforeText = text.substring(0, index);
                const matchText = text.substring(index, index + term.length);
                const afterText = text.substring(index + term.length);
                
                const highlightSpan = document.createElement('span');
                highlightSpan.className = 'highlight';
                highlightSpan.textContent = matchText;
                
                const newContent = document.createDocumentFragment();
                newContent.appendChild(document.createTextNode(beforeText));
                newContent.appendChild(highlightSpan);
                newContent.appendChild(document.createTextNode(afterText));
                
                node.parentNode.replaceChild(newContent, node);
            }
        });
    }
    
    // Fonction pour supprimer le surlignage
    function removeHighlight(row) {
        const highlights = row.querySelectorAll('.highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
            parent.normalize();
        });
    }
    
    // Fonction utilitaire pour obtenir tous les n≈ìuds de texte
    function getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        let node;
        while (node = walker.nextNode()) {
            if (node.parentNode.tagName !== 'SCRIPT' && node.parentNode.tagName !== 'STYLE') {
                textNodes.push(node);
            }
        }
        return textNodes;
    }
    
    // Fonction pour calculer les statistiques avec filtrage
    function calculateFilteredStatistics(searchTerm) {
        const visibleRows = document.querySelectorAll('.searchable-row[style*="display: none"]');
        const allRows = document.querySelectorAll('.searchable-row');
        let entriesCount = 0;
        let exitsCount = 0;
        const uniqueItems = new Set();
        
        allRows.forEach(row => {
            if (row.style.display !== 'none') {
                // Compter les entr√©es et sorties bas√© sur les ic√¥nes ou classes
                const typeCell = row.querySelector('td:nth-child(4)'); // Colonne Type
                if (typeCell) {
                    const typeText = typeCell.textContent.toLowerCase();
                    if (typeText.includes('entr√©e') || typeText.includes('üì•')) {
                        entriesCount++;
                    } else if (typeText.includes('sortie') || typeText.includes('üì§')) {
                        exitsCount++;
                    }
                }
                
                // Compter les articles uniques
                const itemCell = row.querySelector('td:nth-child(2)'); // Colonne Article
                if (itemCell) {
                    const itemText = itemCell.textContent.trim();
                    if (itemText) {
                        uniqueItems.add(itemText);
                    }
                }
            }
        });
        
        // Mettre √† jour les statistiques dans l'interface
        const entriesStat = document.querySelector('[data-stat="entries"]');
        const exitsStat = document.querySelector('[data-stat="exits"]');
        const uniqueItemsStat = document.querySelector('[data-stat="unique-items"]');
        
        if (entriesStat) entriesStat.textContent = entriesCount;
        if (exitsStat) exitsStat.textContent = exitsCount;
        if (uniqueItemsStat) uniqueItemsStat.textContent = uniqueItems.size;
    }
    
    // Fonction pour calculer les statistiques
    function calculateStatistics() {
        const rows = document.querySelectorAll('.searchable-row');
        let entriesCount = 0;
        let exitsCount = 0;
        const uniqueItems = new Set();
        
        rows.forEach(row => {
            // Compter les entr√©es et sorties bas√© sur les ic√¥nes ou classes
            const typeCell = row.querySelector('td:nth-child(4)'); // Colonne Type
            if (typeCell) {
                const typeText = typeCell.textContent.toLowerCase();
                if (typeText.includes('entr√©e') || typeText.includes('üì•')) {
                    entriesCount++;
                } else if (typeText.includes('sortie') || typeText.includes('üì§')) {
                    exitsCount++;
                }
            }
            
            // Compter les articles uniques
            const itemCell = row.querySelector('td:nth-child(2)'); // Colonne Article
            if (itemCell) {
                const itemText = itemCell.textContent.trim();
                if (itemText) {
                    uniqueItems.add(itemText);
                }
            }
        });
        
        // Mettre √† jour les statistiques dans l'interface
        const entriesStat = document.querySelector('[data-stat="entries"]');
        const exitsStat = document.querySelector('[data-stat="exits"]');
        const uniqueItemsStat = document.querySelector('[data-stat="unique-items"]');
        
        if (entriesStat) entriesStat.textContent = entriesCount;
        if (exitsStat) exitsStat.textContent = exitsCount;
        if (uniqueItemsStat) uniqueItemsStat.textContent = uniqueItems.size;
    }
    
    // Animation des statistiques
    const statCards = document.querySelectorAll('.bg-white.p-4');
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
        }, index * 100);
    });
});
</script>
{% endblock %}
